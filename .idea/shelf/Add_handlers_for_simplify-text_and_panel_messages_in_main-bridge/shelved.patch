Index: extension/main-bridge.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>// main-bridge.js - Runs in MAIN world, can access DOM\r\n\r\n// Global settings variables, initialized with defaults\r\nlet currentSimplificationLevel = 50;\r\nlet currentDisableAnimations = false;\r\nlet currentBlockBadWords = false;\r\nlet currentAutomaticSimplification = false;\r\nlet isAutomaticSimplificationActive = false;\r\n\r\n// Helper to generate AI prompt based on slider value\r\nfunction getSimplificationPrompt(level) {\r\n    level = Number(level);\r\n    if (level === 0) return 'Do not change the text.';\r\n    if (level > 0 && level < 50) return 'Slightly simplify the text for someone with autism to easily understand.';\r\n    if (level === 50) return 'Simplify the text to a medium level for accessibility.';\r\n    if (level > 50) return 'Make the text as simple and clear as possible, suitable for maximum accessibility.';\r\n    return 'Simplify the text.';\r\n}\r\n\r\n// Utility: DFS to collect all text nodes\r\nfunction collectTextNodes(root) {\r\n    const nodes = [];\r\n    function dfs(node) {\r\n        for (let child of node.childNodes) {\r\n            if (child.nodeType === Node.TEXT_NODE && child.nodeValue.trim() && /[a-zA-Z]/.test(child.nodeValue) && !/:\\/|www\\./.test(child.nodeValue) && (!child.parentNode || !['SCRIPT', 'STYLE', 'NOSCRIPT', 'IFRAME', 'OBJECT', 'EMBED', 'SVG'].includes(child.parentNode.nodeName))) {\r\n                nodes.push(child);\r\n            } else {\r\n                dfs(child);\r\n            }\r\n        }\r\n    }\r\n    dfs(root);\r\n    return nodes;\r\n}\r\n\r\n// FIFO queue for AI rewrite requests (client-side)\r\nconst aiRewriteQueue = [];\r\nlet aiRewriteActive = false;\r\nlet permissionRequestId = 0;\r\n\r\nfunction requestAIPermission() {\r\n  return new Promise((resolve) => {\r\n    const id = ++permissionRequestId;\r\n    window.postMessage({ type: 'request-ai-permission', id }, '*');\r\n    const listener = (event) => {\r\n      if (event.data.type === 'ai-permission-response' && event.data.id === id) {\r\n        window.removeEventListener('message', listener);\r\n        resolve(event.data.granted);\r\n      }\r\n    };\r\n    window.addEventListener('message', listener);\r\n  });\r\n}\r\n\r\nfunction releaseAIPermission() {\r\n  const id = ++permissionRequestId;\r\n  window.postMessage({ type: 'release-ai-permission', id }, '*');\r\n}\r\n\r\nfunction enqueueAIRewrite(task) {\r\n    return new Promise((resolve, reject) => {\r\n        aiRewriteQueue.push({ task, resolve, reject });\r\n        processAIRewriteQueue();\r\n    });\r\n}\r\n\r\nasync function processAIRewriteQueue() {\r\n    if (aiRewriteActive || aiRewriteQueue.length === 0) return;\r\n    // Request permission from background to ensure only one AI operation globally\r\n    const granted = await requestAIPermission();\r\n    if (!granted) {\r\n        // Permission denied, retry after a short delay\r\n        setTimeout(processAIRewriteQueue, 1000);\r\n        return;\r\n    }\r\n    aiRewriteActive = true;\r\n    const { task, resolve, reject } = aiRewriteQueue.shift();\r\n    try {\r\n        const result = await task();\r\n        resolve(result);\r\n    } catch (e) {\r\n        reject(e);\r\n    } finally {\r\n        aiRewriteActive = false;\r\n        // Release permission\r\n        releaseAIPermission();\r\n        processAIRewriteQueue();\r\n    }\r\n}\r\n\r\n// AI/caching logic: request rewrite using Gemini Nano Rewriter API directly in client, now queued\r\nlet sharedRewriter = null;\r\nlet sharedRewriterOptions = null;\r\nlet sharedAbortController = null;\r\n\r\n// AI rules for rewriting\r\nconst aiRules = \"Do not change proper names, dates, numbers, or technical terms. Preserve the original meaning and structure as much as possible. If the text is already simple, leave it unchanged. Do not define terms, explain concepts, or summarize content. Only simplify words and phrases within the existing sentences. Ignore code snippets, programming code, or technical code.\";\r\n\r\nasync function rewriteTextViaAI(original, simplifyLevel, filterBadWords) {\r\n    return enqueueAIRewrite(async () => {\r\n        if (!isAutomaticSimplificationActive) {\r\n            throw new Error('Cancelled');\r\n        }\r\n        if (!('Rewriter' in self)) {\r\n            console.error('[CLIENT] Gemini Nano Rewriter API not available.');\r\n            return original;\r\n        }\r\n        const available = await Rewriter.availability();\r\n        if (available === 'unavailable') {\r\n            console.error('[CLIENT] Rewriter API is not usable.');\r\n            return original;\r\n        }\r\n        // Use the prompt from the slider\r\n        let prompt = getSimplificationPrompt(simplifyLevel);\r\n        const options = {\r\n            tone: 'as-is',\r\n            length: 'as-is',\r\n            format: 'plain-text',\r\n            sharedContext: aiRules\r\n        };\r\n\r\n        if (filterBadWords) {\r\n            prompt += ' Also, filter out any bad words (cursed words).';\r\n        }\r\n        //console.log('prompt:', prompt);\r\n        if (!isAutomaticSimplificationActive) {\r\n            throw new Error('Cancelled');\r\n        }\r\n        if (!sharedRewriter || JSON.stringify(sharedRewriterOptions) !== JSON.stringify(options)) {\r\n            if (sharedRewriter) sharedRewriter.destroy();\r\n            sharedAbortController = new AbortController();\r\n            sharedRewriter = await Rewriter.create({ ...options, signal: sharedAbortController.signal });\r\n            sharedRewriterOptions = options;\r\n        }\r\n        try {\r\n            const rewrittenText = await sharedRewriter.rewrite(original, { context: prompt });\r\n            //console.log('[AI Transform]\\nOriginal:', original, '\\nRewritten:', rewrittenText);\r\n            return rewrittenText;\r\n        } catch (error) {\r\n            console.error('[CLIENT] Rewrite error:', error);\r\n            return original;\r\n        }\r\n    });\r\n}\r\n\r\n// Replace all text nodes with AI/cached rewrite (calls AI directly)\r\nasync function replaceAllTextNodesWithAI(simplifyLevel, filterBadWords) {\r\n    if (simplifyLevel === 0) {\r\n        return;\r\n    }\r\n    let cache = {};\r\n    let cacheChanged = false;\r\n    try { cache = JSON.parse(localStorage.getItem('rewriteCacheV1')) || {}; } catch { }\r\n    const nodes = collectTextNodes(document.body);\r\n    for (const node of nodes) {\r\n        if (!isAutomaticSimplificationActive) break;\r\n        const key = `${simplifyLevel}:${node.nodeValue}`;\r\n        if (cache[key]) {\r\n            node.nodeValue = cache[key];\r\n        } else {\r\n            try {\r\n                const rewritten = await rewriteTextViaAI(node.nodeValue, simplifyLevel, filterBadWords);\r\n                if (isAutomaticSimplificationActive) {\r\n                    node.nodeValue = rewritten;\r\n                    cache[key] = rewritten;\r\n                    cacheChanged = true;\r\n                }\r\n            } catch (e) {\r\n                if (e.message === 'Cancelled') {\r\n                    // Do not update the node\r\n                } else {\r\n                    console.error('[CLIENT] Rewrite error:', e);\r\n                    if (isAutomaticSimplificationActive) {\r\n                        node.nodeValue = '[AI ERROR] ' + e.message;\r\n                        cache[key] = node.nodeValue;\r\n                        cacheChanged = true;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    if (cacheChanged) {\r\n        localStorage.setItem('rewriteCacheV1', JSON.stringify(cache));\r\n    }\r\n}\r\n\r\nasync function removeAnimationsFromPage() {\r\n    const style = document.createElement('style');\r\n    style.textContent = `\r\n    * {\r\n      animation: none !important;\r\n      transition: none !important;\r\n    }\r\n    `;\r\n    document.head.appendChild(style);\r\n\r\n    // 2. Remove GIFs\r\n    document.querySelectorAll('img[src$=\".gif\"]').forEach(img => img.remove());\r\n\r\n    // 3. Stop and remove <lottie-player> components\r\n    document.querySelectorAll('lottie-player').forEach(player => {\r\n        if (typeof player.stop === 'function') player.stop();\r\n        player.remove();\r\n    });\r\n\r\n    // 4. Stop and destroy lottie-web animations (if any)\r\n    if (window.lottie && typeof window.lottie.getRegisteredAnimations === 'function') {\r\n        const animations = window.lottie.getRegisteredAnimations();\r\n        animations.forEach(anim => {\r\n            if (typeof anim.stop === 'function') anim.stop();\r\n            if (typeof anim.destroy === 'function') anim.destroy();\r\n        });\r\n    }\r\n\r\n    // 5. Remove <canvas> elements (used by Lottie or other animations)\r\n    document.querySelectorAll('canvas').forEach(canvas => canvas.remove());\r\n\r\n    // 6. Remove SVG elements containing <animateTransform>\r\n    document.querySelectorAll('svg').forEach(svg => {\r\n        if (svg.querySelector('animateTransform')) {\r\n            svg.remove();\r\n        }\r\n    });\r\n}\r\n\r\n// On page load, use the saved simplification level\r\nwindow.addEventListener('DOMContentLoaded', () => {\r\n    // Delay automatic actions until settings are received via message\r\n    //console.log('[MAIN] Page loaded, waiting for settings...');\r\n});\r\n\r\nwindow.addEventListener('message', (event) => {\r\n    if (event.data && event.data.type === 'autism-settings-init') {\r\n        // Set global variables from chrome.storage data\r\n        if (event.data.data.autismSimplificationLevel !== undefined) {\r\n            currentSimplificationLevel = Number(event.data.data.autismSimplificationLevel);\r\n        }\r\n        if (event.data.data.autismDisableAnimations !== undefined) {\r\n            currentDisableAnimations = event.data.data.autismDisableAnimations;\r\n        }\r\n        if (event.data.data.autismBlockBadWords !== undefined) {\r\n            currentBlockBadWords = event.data.data.autismBlockBadWords;\r\n        }\r\n        if (event.data.data.autismAutomaticSimplification !== undefined) {\r\n            currentAutomaticSimplification = event.data.data.autismAutomaticSimplification;\r\n            isAutomaticSimplificationActive = currentAutomaticSimplification;\r\n        }\r\n        // Apply settings after loading\r\n        if (currentDisableAnimations) {\r\n            removeAnimationsFromPage();\r\n        }\r\n        if (currentAutomaticSimplification && currentSimplificationLevel > 0) {\r\n            replaceAllTextNodesWithAI(currentSimplificationLevel, currentBlockBadWords);\r\n        }\r\n        return;\r\n    }\r\n    if (event.data && event.data.type === 'autism-settings-update') {\r\n        // Update global variables from storage changes\r\n        if (event.data.data.autismSimplificationLevel !== undefined) {\r\n            currentSimplificationLevel = Number(event.data.data.autismSimplificationLevel);\r\n        }\r\n        if (event.data.data.autismDisableAnimations !== undefined) {\r\n            currentDisableAnimations = event.data.data.autismDisableAnimations;\r\n            if (currentDisableAnimations) {\r\n                removeAnimationsFromPage();\r\n            }\r\n        }\r\n        if (event.data.data.autismBlockBadWords !== undefined) {\r\n            currentBlockBadWords = event.data.data.autismBlockBadWords;\r\n        }\r\n        if (event.data.data.autismAutomaticSimplification !== undefined) {\r\n            const wasActive = currentAutomaticSimplification;\r\n            if (!event.data.data.autismAutomaticSimplification) {\r\n                // Disabling automatic simplification: abort ongoing AI operations and clean up\r\n                isAutomaticSimplificationActive = false;\r\n                if (sharedAbortController) {\r\n                    sharedAbortController.abort();\r\n                }\r\n                if (sharedRewriter) {\r\n                    sharedRewriter.destroy();\r\n                    sharedRewriter = null;\r\n                }\r\n                sharedRewriterOptions = null;\r\n                // Clear the queue to stop pending tasks\r\n                aiRewriteQueue.length = 0;\r\n                aiRewriteActive = false;\r\n            } else {\r\n                isAutomaticSimplificationActive = true;\r\n                if (!wasActive && currentSimplificationLevel > 0) {\r\n                    replaceAllTextNodesWithAI(currentSimplificationLevel, currentBlockBadWords);\r\n                }\r\n            }\r\n            currentAutomaticSimplification = event.data.data.autismAutomaticSimplification;\r\n        }\r\n        return;\r\n    }\r\n    if (event.data && event.data.type === 'autism-simplify-panel') {\r\n        if (event.data.clearCache) {\r\n            localStorage.removeItem('rewriteCacheV1');\r\n            return;\r\n        }\r\n        return;\r\n    }\r\n    if (event.data && event.data.type === 'summary-panel') {\r\n        const selection = window.getSelection();\r\n        if (!selection.rangeCount) return;\r\n        const range = selection.getRangeAt(0);\r\n        // Replace the selected text with the summary\r\n        range.deleteContents();\r\n        range.insertNode(document.createTextNode(event.data.message));\r\n    }\r\n    if (event.data && event.data.type === 'retry-ai-queue') {\r\n        processAIRewriteQueue();\r\n    }\r\n    if (event.data && event.data.type === 'ai-permission-response') {\r\n        // handled in requestAIPermission\r\n    }\r\n    if (event.data && event.data.type === 'ai-permission-released') {\r\n        // handled\r\n    }\r\n});
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/extension/main-bridge.js b/extension/main-bridge.js
--- a/extension/main-bridge.js	(revision f6c299650fe8759c365c6482caef9fb5f798c63f)
+++ b/extension/main-bridge.js	(date 1760748972405)
@@ -299,9 +299,11 @@
             localStorage.removeItem('rewriteCacheV1');
             return;
         }
+        alert('Received simplify-panel message, but no handler implemented.');
         return;
     }
     if (event.data && event.data.type === 'summary-panel') {
+        alert('Received summary-panel message.');
         const selection = window.getSelection();
         if (!selection.rangeCount) return;
         const range = selection.getRangeAt(0);
@@ -309,6 +311,14 @@
         range.deleteContents();
         range.insertNode(document.createTextNode(event.data.message));
     }
+    if (event.data && event.data.type === 'simplify-text') {
+        const selection = window.getSelection();
+        if (!selection.rangeCount) return;
+        const range = selection.getRangeAt(0);
+        // Replace the selected text with the simplified text
+        range.deleteContents();
+        range.insertNode(document.createTextNode(event.data.text));
+    }
     if (event.data && event.data.type === 'retry-ai-queue') {
         processAIRewriteQueue();
     }
